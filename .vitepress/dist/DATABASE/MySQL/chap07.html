<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>事务是否需要隔离 | LWG Study</title>
    <meta name="description" content="A VitePress Site">
    <meta name="generator" content="VitePress v1.2.2">
    <link rel="preload stylesheet" href="/assets/style.ru6fHfS6.css" as="style">
    
    <script type="module" src="/assets/app.BhxXKgYK.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.C70_P7hw.js">
    <link rel="modulepreload" href="/assets/chunks/theme.BpEB4cZC.js">
    <link rel="modulepreload" href="/assets/DATABASE_MySQL_chap07.md.CY0oFLGW.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-bf403e95><!--[--><!--]--><!--[--><span tabindex="-1" data-v-1c5a89bd></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-1c5a89bd> Skip to content </a><!--]--><!----><header class="VPNav" data-v-bf403e95 data-v-5d51f9b9><div class="VPNavBar has-sidebar top" data-v-5d51f9b9 data-v-46bc1d00><div class="wrapper" data-v-46bc1d00><div class="container" data-v-46bc1d00><div class="title" data-v-46bc1d00><div class="VPNavBarTitle has-sidebar" data-v-46bc1d00 data-v-4bb1af6f><a class="title" href="/" data-v-4bb1af6f><!--[--><!--]--><!----><span data-v-4bb1af6f>LWG Study</span><!--[--><!--]--></a></div></div><div class="content" data-v-46bc1d00><div class="content-body" data-v-46bc1d00><!--[--><!--]--><div class="VPNavBarSearch search" data-v-46bc1d00><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-46bc1d00 data-v-b71c1798><span id="main-nav-aria-label" class="visually-hidden" data-v-b71c1798>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/SpringBoot/chapter1.html" tabindex="0" data-v-b71c1798 data-v-5a301c13><!--[--><span data-v-5a301c13>SpringBoot</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/DATABASE/MySQL/chap00.html" tabindex="0" data-v-b71c1798 data-v-5a301c13><!--[--><span data-v-5a301c13>DATABASE</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/JAVA/%E5%9F%BA%E7%A1%80/chapter1.html" tabindex="0" data-v-b71c1798 data-v-5a301c13><!--[--><span data-v-5a301c13>JAVA</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-46bc1d00 data-v-583f7be7><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-583f7be7 data-v-366ae653 data-v-46fdce64><span class="check" data-v-46fdce64><span class="icon" data-v-46fdce64><!--[--><span class="vpi-sun sun" data-v-366ae653></span><span class="vpi-moon moon" data-v-366ae653></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-46bc1d00 data-v-c1ddac85 data-v-1c05cfa7><!--[--><a class="VPSocialLink no-icon" href="https://gitee.com/gasj0ee/java_No1_knowledge/tree/master/" aria-label="github" target="_blank" rel="noopener" data-v-1c05cfa7 data-v-f4be3c87><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-46bc1d00 data-v-16ac573a data-v-f7c62dd4><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-f7c62dd4><span class="vpi-more-horizontal icon" data-v-f7c62dd4></span></button><div class="menu" data-v-f7c62dd4><div class="VPMenu" data-v-f7c62dd4 data-v-309b610c><!----><!--[--><!--[--><!----><div class="group" data-v-16ac573a><div class="item appearance" data-v-16ac573a><p class="label" data-v-16ac573a>Appearance</p><div class="appearance-action" data-v-16ac573a><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-16ac573a data-v-366ae653 data-v-46fdce64><span class="check" data-v-46fdce64><span class="icon" data-v-46fdce64><!--[--><span class="vpi-sun sun" data-v-366ae653></span><span class="vpi-moon moon" data-v-366ae653></span><!--]--></span></span></button></div></div></div><div class="group" data-v-16ac573a><div class="item social-links" data-v-16ac573a><div class="VPSocialLinks social-links-list" data-v-16ac573a data-v-1c05cfa7><!--[--><a class="VPSocialLink no-icon" href="https://gitee.com/gasj0ee/java_No1_knowledge/tree/master/" aria-label="github" target="_blank" rel="noopener" data-v-1c05cfa7 data-v-f4be3c87><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-46bc1d00 data-v-04513a86><span class="container" data-v-04513a86><span class="top" data-v-04513a86></span><span class="middle" data-v-04513a86></span><span class="bottom" data-v-04513a86></span></span></button></div></div></div></div><div class="divider" data-v-46bc1d00><div class="divider-line" data-v-46bc1d00></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-bf403e95 data-v-206e55a3><div class="container" data-v-206e55a3><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-206e55a3><span class="vpi-align-left menu-icon" data-v-206e55a3></span><span class="menu-text" data-v-206e55a3>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-206e55a3 data-v-501b643f><button data-v-501b643f>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-bf403e95 data-v-98e42a8e><div class="curtain" data-v-98e42a8e></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-98e42a8e><span class="visually-hidden" id="sidebar-aria-label" data-v-98e42a8e> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-98e42a8e><section class="VPSidebarItem level-0 collapsible has-active" data-v-98e42a8e data-v-e16b36d7><div class="item" role="button" tabindex="0" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><h2 class="text" data-v-e16b36d7>MySQL</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e16b36d7><span class="vpi-chevron-right caret-icon" data-v-e16b36d7></span></div></div><div class="items" data-v-e16b36d7><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap00.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>MySQL 底层数据结构：B+树</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap01.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>MySQL基础架构</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap02.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>MySQL日志系统</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap03.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>事务隔离</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap04.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>索引</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap05.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>全局锁和表锁</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap06.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>行锁</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap07.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>事务是否需要隔离</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap08.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>普通索引和唯一索引</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap09.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>MySQL为什么会选错索引？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap10.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>如何给字符串加索引？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap11.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>为什么 MySQL 会“抖”一下</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap12.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>MySQL数据库表的空间回收</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap13.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>count(\*)语句</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap14.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>日志和索引相关问题</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap15.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>order by 是如何工作的</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap16.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>如何正确显示随机消息</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap17.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>为什么 SQL 语句逻辑相同，但性能却差异巨大？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/DATABASE/MySQL/chap18.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>为什么查询一行的语句，执行也会很慢</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-bf403e95 data-v-b3d11645><div class="VPDoc has-sidebar has-aside" data-v-b3d11645 data-v-95d215ae><!--[--><!--]--><div class="container" data-v-95d215ae><div class="aside" data-v-95d215ae><div class="aside-curtain" data-v-95d215ae></div><div class="aside-container" data-v-95d215ae><div class="aside-content" data-v-95d215ae><div class="VPDocAside" data-v-95d215ae data-v-0148090c><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-0148090c data-v-92f2a883><div class="content" data-v-92f2a883><div class="outline-marker" data-v-92f2a883></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-92f2a883>On this page</div><ul class="VPDocOutlineItem root" data-v-92f2a883 data-v-2afd1398><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-0148090c></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-95d215ae><div class="content-container" data-v-95d215ae><!--[--><!--]--><main class="main" data-v-95d215ae><div style="position:relative;" class="vp-doc _DATABASE_MySQL_chap07" data-v-95d215ae><div><h1 id="事务是否需要隔离" tabindex="-1">事务是否需要隔离 <a class="header-anchor" href="#事务是否需要隔离" aria-label="Permalink to &quot;事务是否需要隔离&quot;">​</a></h1><p>可重复读隔离级别下，执行行锁时，事务在获取到行锁要更新数据时，读到的数据会是什么？</p><h2 id="示例说明" tabindex="-1">示例说明 <a class="header-anchor" href="#示例说明" aria-label="Permalink to &quot;示例说明&quot;">​</a></h2><p>以下是只有两行表的初始化语句</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mysql</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> `t`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `id`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `k`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  PRIMARY KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`id`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) ENGINE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">InnoDB;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">insert into</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> t(id, k) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">values</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h3 id="注意事项" tabindex="-1">注意事项 <a class="header-anchor" href="#注意事项" aria-label="Permalink to &quot;注意事项&quot;">​</a></h3><ul><li>begin/start transaction 命令并不是一个事务的起点，在执行到它们之后的第一个操作InnoDB表的语句（第一个快照读语句），事务才真正启动。</li><li>autocommit默认为1，则一个语句的执行本身就是一个事务，在语句完成后将会自动提交</li></ul><p><img src="/assets/1.CEMPwhll.png" alt="image"></p><p><mark>在这种情况下，事务B查到的k的值是3，而事务A查到的k的值是1</mark>；</p><p>事务B在更新了行之后查询; 事务A在一个只读事务中查询，并且时间顺序上是在事务B的查询之后。</p><p>MySQL中存在两个“视图”的概念：</p><ul><li><p>一个是view。它是一个用查询语句定义的虚拟表，在调用的时候执行查询语句并生成结果。创建视图的语法是create view ... ，而它的查询方法与表一样。</p></li><li><p>另一个是<strong>InnoDB在实现MVCC时用到的一致性读视图</strong>，即consistent read view，用于支持RC（Read Committed，读提交）和RR（Repeatable Read，可重复读）隔离级别的实现。</p></li></ul><h2 id="快照-在mvcc里是怎么工作的" tabindex="-1">“快照”在MVCC里是怎么工作的？ <a class="header-anchor" href="#快照-在mvcc里是怎么工作的" aria-label="Permalink to &quot;“快照”在MVCC里是怎么工作的？&quot;">​</a></h2><p>在可重复读隔离级别下，事务在启动时进行快照。这个快照是<strong>基于整库的</strong>。</p><h3 id="快照是如何实现的" tabindex="-1">快照是如何实现的？ <a class="header-anchor" href="#快照是如何实现的" aria-label="Permalink to &quot;快照是如何实现的？&quot;">​</a></h3><ul><li><mark>InnoDB里面每个事务有一个唯一的事务ID，叫作transaction id</mark>。它是在事务开始的时候向InnoDB的事务系统申请的，是按申请顺序严格递增的。</li><li>每次事务更新数据的时候，都会生成一个新的数据版本，并且把transaction id赋值给这个数据版本的事务ID，记为row trx_id。</li><li>同时，旧的数据版本要保留，并且在新的数据版本中，能够有信息可以直接拿到它</li></ul><p>如图所示，一个记录被多个事务连续更新后的所有状态</p><p><img src="/assets/2.l8bI1kBv.png" alt="image"></p><ul><li>图中虚线框里是同一行数据的4个版本，当前最新版本是V4，k的值是22，它是被transaction id 为25的事务更新的，因此它的row trx_id也是25。</li><li>图中中的三个虚线箭头，就是undo log（回滚日志）</li><li>V1、V2、V3并不是物理上真实存在的，而是<strong>每次需要的时候根据当前版本和undo log计算出来的</strong>。</li></ul><h3 id="innodb如何定义快照" tabindex="-1">InnoDB如何定义快照 <a class="header-anchor" href="#innodb如何定义快照" aria-label="Permalink to &quot;InnoDB如何定义快照&quot;">​</a></h3><p>事实上，一个事务只需要在启动的时候声明说，“以我启动的时刻为准，如果一个数据版本是在我启动之前生成的，就认；如果是我启动以后才生成的，我就不认，我必须要找到它的上一个版本”。但上一个版本不存在，则会继续往前检索。</p><ul><li>在实现上， InnoDB为每个事务构造了一个数组，用来保存这个事务启动瞬间，当前正在“活跃”的所有事务ID。<strong>活跃”指的就是，启动了但还没提交</strong></li><li>数组里面事务ID的最小值记为低水位，当前系统里面已经创建过的<mark>事务ID的最大值加1记为高水位</mark>。</li><li>这个视图数组和高水位，就组成了当前事务的一致性视图（read-view）</li><li>数据版本的可见性规则，就是基于数据的row trx_id和这个一致性视图的对比结果得到的</li></ul><p><img src="/assets/3.C8dicSiP.png" alt="image"></p><p>对于当前事务的启动瞬间来说，一个数据版本的row trx_id，有以下几种可能:</p><ol><li><p>如果落在绿色部分，表示这个版本是已提交的事务或者是当前事务自己生成的，这个数据是可见的；</p></li><li><p>如果落在红色部分，表示这个版本是由将来启动的事务生成的，是肯定不可见的；</p></li><li><p>如果落在黄色部分，那就包括两种情况</p><p>a. 若 row trx_id在数组中，表示这个版本是由还没提交的事务生成的，不可见；</p><p>b. 若 row trx_id不在数组中，表示这个版本是已经提交了的事务生成的，可见。</p></li></ol><p>而系统后面的更新下，生成的版本一定属于上面的2或者3(a)的情况，对于当前的事务来说，这些新的数据版本是不存在的，所以这个事务的快照，就是“静态”的。</p><p>因此，<strong>InnoDB利用了“所有数据都有多个版本”的这个特性，实现了“秒级创建快照”的能力</strong>。</p><p>*** 分析示例中事务A返回的结果为什么k=1?</p><p>假设：</p><ol><li>事务A开始前，系统里面只有一个活跃事务ID是99；</li><li>事务A、B、C的版本号分别是100、101、102，且当前系统里只有这四个事务；</li><li>三个事务开始前，(1,1)这一行数据的row trx_id是90。</li></ol><p>事务A的视图数组就是[99,100], 事务B的视图数组是[99,100,101], 事务C的视图数组是[99,100,101,102] 。而事务A查询逻辑如下所示：</p><p><img src="/assets/4.CEo2_RJ7.png" alt="image"></p><ul><li>从图中可以看到，第一个有效更新是事务C，把数据从(1,1)改成了(1,2)。这时候，这个数据的最新版本的row trx_id是102，而90这个版本已经成为了历史版本。</li><li>第二个有效更新是事务B，把数据从(1,2)改成了(1,3)。这时候，这个数据的最新版本（即row trx_id）是101，而102又成为了历史版本。</li><li>事务A查询的时候，其实事务B还没有提交，但是它生成的(1,3)这个版本已经变成当前版本了，因此该版本对事务A是不可见的，否则会<strong>脏读</strong></li><li>事务A查询语句的读数据流程: <ul><li>找到(1,3)的时候，判断出row trx_id=101，比高水位大，处于红色区域，不可见；</li><li>接着，找到上一个历史版本，一看row trx_id=102，比高水位大，处于红色区域，不可见；</li><li>再往前找，终于找到了（1,1），它的row trx_id=90，比低水位小，处于绿色区域，可见。</li></ul></li></ul><p>则相应的，一个数据版本对于一个事务视图来说，有三种情况：</p><ol><li>版本未提交，不可见；</li><li>版本已提交，但是是在视图创建后提交的，不可见；</li><li>版本已提交，而且是在视图创建前提交的，可见。</li></ol><h2 id="更新逻辑" tabindex="-1">更新逻辑 <a class="header-anchor" href="#更新逻辑" aria-label="Permalink to &quot;更新逻辑&quot;">​</a></h2><p>事务B的更新逻辑图如下所示：</p><p><img src="/assets/5.hLXS0tgz.png" alt="image"></p><p>事务B在更新操作之前执行查询操作，而得到的结果为k=1；而执行更新操作时，不能再在历史版本上（k=1）更新，否则事务C的更新就丢失了。因此，此时事务B的更新是在事务C的更新执行（1，2）的基础上来进行的。</p><p>所使用的规则：更新数据都是先读后写的，<strong>而这个读，只能读当前的值，称为“当前读”（current read）</strong></p><p>因此，在更新的时候，<strong>当前读</strong>拿到的数据是(1,2)，更新后生成了新版本的数据(1,3)，这个新版本的row trx_id是101。 在执行事务B查询语句的时候，一看自己的版本号是101，最新数据的版本号也是101，是自己的更新，可以直接使用，所以查询得到的k的值是3。</p><p>假设事务C不是马上提交的，而是变成了下面的事务C’，即：</p><p><img src="/assets/6._yih6Rwr.png" alt="image"></p><p>此处，便使用两阶段锁协议进行处理：事务C’没提交，也就是说(1,2)这个版本上的写锁还没释放；而事务B是当前读，必须要读最新版本，而且必须加锁，因此就被锁住了，<strong>必须等到事务C’释放这个锁，才能继续它的当前读</strong>。</p><ul><li>可重复读的核心就是一致性读（consistent read）；而事务更新数据的时候，只能用当前读。</li><li>如果当前的记录的行锁被其他事务占用的话，就需要进入锁等待。</li></ul><p>读提交的逻辑和可重复读的逻辑类似，它们最主要的区别是：</p><ul><li>在可重复读隔离级别下，只需要在事务开始的时候创建一致性视图，之后事务里的其他查询都共用这个一致性视图；</li><li>在读提交隔离级别下，每一个语句执行前都会重新算出一个新的视图。</li></ul><p>普通查询语句是一致性读，一致性读会根据row trx_id和一致性视图确定数据版本的可见性。</p><ul><li>对于可重复读，查询只承认在<strong>事务</strong>启动前就已经提交完成的数据；</li><li>对于读提交，查询只承认在<strong>语句</strong>启动前就已经提交完成的数据；</li></ul><p><mark>注意的点：</mark></p><ul><li>Innodb 要保证这个规则：事务启动以前所有还没提交的事务，它都不可见。</li><li>只存一个已经提交事务的最大值是不够的，一些比最大值小的事务也有可能更新。</li><li>事务启动时还会保存“现在正在执行的所有事物ID列表”，如果一个row trx_id在这列表中，也要不可见。</li></ul></div></div></main><footer class="VPDocFooter" data-v-95d215ae data-v-19c972ee><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-19c972ee><span class="visually-hidden" id="doc-footer-aria-label" data-v-19c972ee>Pager</span><div class="pager" data-v-19c972ee><a class="VPLink link pager-link prev" href="/DATABASE/MySQL/chap06.html" data-v-19c972ee><!--[--><span class="desc" data-v-19c972ee>Previous page</span><span class="title" data-v-19c972ee>行锁</span><!--]--></a></div><div class="pager" data-v-19c972ee><a class="VPLink link pager-link next" href="/DATABASE/MySQL/chap08.html" data-v-19c972ee><!--[--><span class="desc" data-v-19c972ee>Next page</span><span class="title" data-v-19c972ee>普通索引和唯一索引</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"database_mysql_chap06.md\":\"BbUIwKK1\",\"database_mysql_chap12.md\":\"M9_om4eA\",\"database_mysql_chap11.md\":\"B5SJAVry\",\"database_mysql_chap13.md\":\"Direv8j1\",\"database_mysql_chap01.md\":\"Ci1qcRa7\",\"database_mysql_chap18.md\":\"Dp9DnuJH\",\"database_mysql_chap00.md\":\"BM8HNyfJ\",\"intro.md\":\"CkJCjlR6\",\"database_mysql_chap02.md\":\"t5_m2sdP\",\"database_mysql_chap05.md\":\"BmfYVg8N\",\"database_mysql_chap08.md\":\"sjugScbW\",\"database_mysql_chap14.md\":\"vpLkgWJY\",\"database_mysql_chap09.md\":\"DTmlon-9\",\"java_基础_chapter13.md\":\"B5Mu2Hxf\",\"database_mysql_chap07.md\":\"CY0oFLGW\",\"database_mysql_chap10.md\":\"BYrjNhNU\",\"java_基础_chapter1.md\":\"BBo1m5R8\",\"database_mysql_chap17.md\":\"BDfbhkAb\",\"readme.md\":\"BbvCBKSX\",\"java_集合框架_collection_priorityqueue.md\":\"CFfvWL8S\",\"database_mysql_chap03.md\":\"BXtr4_5m\",\"java_基础_chapter2.md\":\"Deh0e1e_\",\"java_基础_chapter12.md\":\"BGVQjt7d\",\"database_mysql_chap16.md\":\"DZxrX8xf\",\"java_基础_chapter9.md\":\"BlWzp7p1\",\"index.md\":\"Bs8sgi3X\",\"java_集合框架_collection_arraydeque.md\":\"BYqqXK0m\",\"java_基础_chapter5.md\":\"CokY6fk0\",\"database_mysql_chap04.md\":\"RxuYHuCd\",\"springboot_chapter1.md\":\"DV65ecMJ\",\"java_基础_chapter7.md\":\"DqrtA3Hv\",\"database_mysql_chap15.md\":\"CdqqOT2H\",\"java_基础_chapter6.md\":\"D18DAQog\",\"java_基础_chapter11.md\":\"BMfuAG32\",\"java_基础_chapter10.md\":\"CgD2EtbK\",\"java_集合框架_collection-arraylist.md\":\"B9XfulVZ\",\"java_基础_chapter4.md\":\"B9AvAT9S\",\"java_集合框架_collection_linkedlist.md\":\"Dns1xqGf\",\"java_基础_chapter3.md\":\"CjIU5EpI\",\"java_基础_chapter14.md\":\"Div61QB6\",\"java_基础_chapter8.md\":\"VRf9RRMy\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"LWG Study\",\"description\":\"A VitePress Site\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://gitee.com/gasj0ee/java_No1_knowledge/tree/master/\"}],\"nav\":[{\"text\":\"SpringBoot\",\"activeMatch\":\"/SpringBoot/\",\"link\":\"/SpringBoot/chapter1\"},{\"text\":\"DATABASE\",\"activeMatch\":\"/DATABASE/\",\"link\":\"/DATABASE/MySQL/chap00\"},{\"text\":\"JAVA\",\"activeMatch\":\"/JAVA/\",\"link\":\"/JAVA/基础/chapter1\"}],\"sidebar\":{\"/SpringBoot/\":[{\"text\":\"chapter1\",\"link\":\"/SpringBoot/chapter1\"}],\"/DATABASE/\":[{\"text\":\"MySQL\",\"collapsed\":false,\"items\":[{\"text\":\"MySQL 底层数据结构：B+树\",\"link\":\"/DATABASE/MySQL/chap00\"},{\"text\":\"MySQL基础架构\",\"link\":\"/DATABASE/MySQL/chap01\"},{\"text\":\"MySQL日志系统\",\"link\":\"/DATABASE/MySQL/chap02\"},{\"text\":\"事务隔离\",\"link\":\"/DATABASE/MySQL/chap03\"},{\"text\":\"索引\",\"link\":\"/DATABASE/MySQL/chap04\"},{\"text\":\"全局锁和表锁\",\"link\":\"/DATABASE/MySQL/chap05\"},{\"text\":\"行锁\",\"link\":\"/DATABASE/MySQL/chap06\"},{\"text\":\"事务是否需要隔离\",\"link\":\"/DATABASE/MySQL/chap07\"},{\"text\":\"普通索引和唯一索引\",\"link\":\"/DATABASE/MySQL/chap08\"},{\"text\":\"MySQL为什么会选错索引？\",\"link\":\"/DATABASE/MySQL/chap09\"},{\"text\":\"如何给字符串加索引？\",\"link\":\"/DATABASE/MySQL/chap10\"},{\"text\":\"为什么 MySQL 会“抖”一下\",\"link\":\"/DATABASE/MySQL/chap11\"},{\"text\":\"MySQL数据库表的空间回收\",\"link\":\"/DATABASE/MySQL/chap12\"},{\"text\":\"count(\\\\*)语句\",\"link\":\"/DATABASE/MySQL/chap13\"},{\"text\":\"日志和索引相关问题\",\"link\":\"/DATABASE/MySQL/chap14\"},{\"text\":\"order by 是如何工作的\",\"link\":\"/DATABASE/MySQL/chap15\"},{\"text\":\"如何正确显示随机消息\",\"link\":\"/DATABASE/MySQL/chap16\"},{\"text\":\"为什么 SQL 语句逻辑相同，但性能却差异巨大？\",\"link\":\"/DATABASE/MySQL/chap17\"},{\"text\":\"为什么查询一行的语句，执行也会很慢\",\"link\":\"/DATABASE/MySQL/chap18\"}]}],\"/JAVA/\":[{\"text\":\"集合框架\",\"collapsed\":false,\"items\":[{\"text\":\"ArrayList源码解析\",\"link\":\"/JAVA/集合框架/Collection-ArrayList\"},{\"text\":\"Stack & Queue (采用 ArrayDeque 实现)\",\"link\":\"/JAVA/集合框架/Collection_ArrayDeque\"},{\"text\":\"Collection - LinkedList 源码解析\",\"link\":\"/JAVA/集合框架/Collection_LinkedList\"},{\"text\":\"PriorityQueue 源码解析\",\"link\":\"/JAVA/集合框架/Collection_PriorityQueue\"}]},{\"text\":\"基础\",\"collapsed\":false,\"items\":[{\"text\":\"Java 简介\",\"link\":\"/JAVA/基础/chapter1\"},{\"text\":\"类、源文件、包、jar、模块、工程\",\"link\":\"/JAVA/基础/chapter10\"},{\"text\":\"反射\",\"link\":\"/JAVA/基础/chapter11\"},{\"text\":\"异常和断言\",\"link\":\"/JAVA/基础/chapter12\"},{\"text\":\"日志\",\"link\":\"/JAVA/基础/chapter13\"},{\"text\":\"集合\",\"link\":\"/JAVA/基础/chapter14\"},{\"text\":\"Java 基本程序设计结构\",\"link\":\"/JAVA/基础/chapter2\"},{\"text\":\"类\",\"link\":\"/JAVA/基础/chapter3\"},{\"text\":\"接口\",\"link\":\"/JAVA/基础/chapter4\"},{\"text\":\"lambda表达式\",\"link\":\"/JAVA/基础/chapter5\"},{\"text\":\"内部类\",\"link\":\"/JAVA/基础/chapter6\"},{\"text\":\"代理\",\"link\":\"/JAVA/基础/chapter7\"},{\"text\":\"泛型\",\"link\":\"/JAVA/基础/chapter8\"},{\"text\":\"关键字\",\"link\":\"/JAVA/基础/chapter9\"}]}]}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>