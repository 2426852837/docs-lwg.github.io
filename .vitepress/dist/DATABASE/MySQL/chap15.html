<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>order by 是如何工作的 | LWG Study</title>
    <meta name="description" content="A VitePress Site">
    <meta name="generator" content="VitePress v1.2.2">
    <link rel="preload stylesheet" href="/docs-lwg.github.io/assets/style.Cawybzla.css" as="style">
    
    <script type="module" src="/docs-lwg.github.io/assets/app.EoBF2vFJ.js"></script>
    <link rel="preload" href="/docs-lwg.github.io/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/docs-lwg.github.io/assets/chunks/framework.BzbwRryB.js">
    <link rel="modulepreload" href="/docs-lwg.github.io/assets/chunks/theme.0UM95K8H.js">
    <link rel="modulepreload" href="/docs-lwg.github.io/assets/DATABASE_MySQL_chap15.md.BHHf80nm.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-bf403e95><!--[--><!--]--><!--[--><span tabindex="-1" data-v-1c5a89bd></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-1c5a89bd> Skip to content </a><!--]--><!----><header class="VPNav" data-v-bf403e95 data-v-5d51f9b9><div class="VPNavBar has-sidebar top" data-v-5d51f9b9 data-v-46bc1d00><div class="wrapper" data-v-46bc1d00><div class="container" data-v-46bc1d00><div class="title" data-v-46bc1d00><div class="VPNavBarTitle has-sidebar" data-v-46bc1d00 data-v-4bb1af6f><a class="title" href="/docs-lwg.github.io/" data-v-4bb1af6f><!--[--><!--]--><!----><span data-v-4bb1af6f>LWG Study</span><!--[--><!--]--></a></div></div><div class="content" data-v-46bc1d00><div class="content-body" data-v-46bc1d00><!--[--><!--]--><div class="VPNavBarSearch search" data-v-46bc1d00><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-46bc1d00 data-v-b71c1798><span id="main-nav-aria-label" class="visually-hidden" data-v-b71c1798>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/docs-lwg.github.io/DATABASE/MySQL/chap00.html" tabindex="0" data-v-b71c1798 data-v-5a301c13><!--[--><span data-v-5a301c13>DATABASE</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/docs-lwg.github.io/SpringBoot/chapter1.html" tabindex="0" data-v-b71c1798 data-v-5a301c13><!--[--><span data-v-5a301c13>SpringBoot</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/docs-lwg.github.io/JAVA/%E5%9F%BA%E7%A1%80/chapter1.html" tabindex="0" data-v-b71c1798 data-v-5a301c13><!--[--><span data-v-5a301c13>JAVA</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-46bc1d00 data-v-583f7be7><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-583f7be7 data-v-366ae653 data-v-46fdce64><span class="check" data-v-46fdce64><span class="icon" data-v-46fdce64><!--[--><span class="vpi-sun sun" data-v-366ae653></span><span class="vpi-moon moon" data-v-366ae653></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-46bc1d00 data-v-c1ddac85 data-v-1c05cfa7><!--[--><a class="VPSocialLink no-icon" href="https://gitee.com/gasj0ee/java_No1_knowledge/tree/master/" aria-label="github" target="_blank" rel="noopener" data-v-1c05cfa7 data-v-f4be3c87><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-46bc1d00 data-v-16ac573a data-v-f7c62dd4><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-f7c62dd4><span class="vpi-more-horizontal icon" data-v-f7c62dd4></span></button><div class="menu" data-v-f7c62dd4><div class="VPMenu" data-v-f7c62dd4 data-v-309b610c><!----><!--[--><!--[--><!----><div class="group" data-v-16ac573a><div class="item appearance" data-v-16ac573a><p class="label" data-v-16ac573a>Appearance</p><div class="appearance-action" data-v-16ac573a><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-16ac573a data-v-366ae653 data-v-46fdce64><span class="check" data-v-46fdce64><span class="icon" data-v-46fdce64><!--[--><span class="vpi-sun sun" data-v-366ae653></span><span class="vpi-moon moon" data-v-366ae653></span><!--]--></span></span></button></div></div></div><div class="group" data-v-16ac573a><div class="item social-links" data-v-16ac573a><div class="VPSocialLinks social-links-list" data-v-16ac573a data-v-1c05cfa7><!--[--><a class="VPSocialLink no-icon" href="https://gitee.com/gasj0ee/java_No1_knowledge/tree/master/" aria-label="github" target="_blank" rel="noopener" data-v-1c05cfa7 data-v-f4be3c87><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-46bc1d00 data-v-04513a86><span class="container" data-v-04513a86><span class="top" data-v-04513a86></span><span class="middle" data-v-04513a86></span><span class="bottom" data-v-04513a86></span></span></button></div></div></div></div><div class="divider" data-v-46bc1d00><div class="divider-line" data-v-46bc1d00></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-bf403e95 data-v-206e55a3><div class="container" data-v-206e55a3><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-206e55a3><span class="vpi-align-left menu-icon" data-v-206e55a3></span><span class="menu-text" data-v-206e55a3>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-206e55a3 data-v-501b643f><button data-v-501b643f>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-bf403e95 data-v-98e42a8e><div class="curtain" data-v-98e42a8e></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-98e42a8e><span class="visually-hidden" id="sidebar-aria-label" data-v-98e42a8e> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-98e42a8e><section class="VPSidebarItem level-0 collapsible has-active" data-v-98e42a8e data-v-e16b36d7><div class="item" role="button" tabindex="0" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><h2 class="text" data-v-e16b36d7>MySQL</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e16b36d7><span class="vpi-chevron-right caret-icon" data-v-e16b36d7></span></div></div><div class="items" data-v-e16b36d7><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap00.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>MySQL 底层数据结构：B+树</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap01.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>MySQL基础架构</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap02.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>MySQL日志系统</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap03.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>事务隔离</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap04.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>索引</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap05.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>全局锁和表锁</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap06.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>行锁</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap07.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>事务是否需要隔离</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap08.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>普通索引和唯一索引</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap09.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>MySQL为什么会选错索引？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap10.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>如何给字符串加索引？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap11.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>为什么 MySQL 会“抖”一下</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap12.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>MySQL数据库表的空间回收</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap13.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>count(\*)语句</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap14.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>日志和索引相关问题</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap15.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>order by 是如何工作的</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap16.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>如何正确显示随机消息</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap17.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>为什么 SQL 语句逻辑相同，但性能却差异巨大？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e16b36d7 data-v-e16b36d7><div class="item" data-v-e16b36d7><div class="indicator" data-v-e16b36d7></div><a class="VPLink link link" href="/docs-lwg.github.io/DATABASE/MySQL/chap18.html" data-v-e16b36d7><!--[--><p class="text" data-v-e16b36d7>为什么查询一行的语句，执行也会很慢</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-bf403e95 data-v-b3d11645><div class="VPDoc has-sidebar has-aside" data-v-b3d11645 data-v-95d215ae><!--[--><!--]--><div class="container" data-v-95d215ae><div class="aside" data-v-95d215ae><div class="aside-curtain" data-v-95d215ae></div><div class="aside-container" data-v-95d215ae><div class="aside-content" data-v-95d215ae><div class="VPDocAside" data-v-95d215ae data-v-0148090c><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-0148090c data-v-92f2a883><div class="content" data-v-92f2a883><div class="outline-marker" data-v-92f2a883></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-92f2a883>On this page</div><ul class="VPDocOutlineItem root" data-v-92f2a883 data-v-2afd1398><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-0148090c></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-95d215ae><div class="content-container" data-v-95d215ae><!--[--><!--]--><main class="main" data-v-95d215ae><div style="position:relative;" class="vp-doc _docs-lwg_github_io_DATABASE_MySQL_chap15" data-v-95d215ae><div><h1 id="order-by-是如何工作的" tabindex="-1">order by 是如何工作的 <a class="header-anchor" href="#order-by-是如何工作的" aria-label="Permalink to &quot;order by 是如何工作的&quot;">​</a></h1><h2 id="全字段排序" tabindex="-1">全字段排序 <a class="header-anchor" href="#全字段排序" aria-label="Permalink to &quot;全字段排序&quot;">​</a></h2><p>示例语句：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> city,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,age </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> t </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> city</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;杭州&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> order by</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>其中，Extra字段中的&quot;Using filesoft&quot;表示需要排序，<mark>MySQL会给每个线程分配一块内存用于排序，称为 sort_buffer。</mark></p><p>city索引的示意图如下所示： <img src="/docs-lwg.github.io/assets/1.DNBSWzwC.png" alt="image"></p><p>通常情况下，该语句的执行流程是：</p><ol><li>初始化 sort_buffer，确定放入 name、city、age 这三个字段；</li><li>从索引 city 找到第一个满足 city=‘杭州’条件的主键 id，也就是图中的 ID_X；</li><li>到主键 id 索引取出整行，取 name、city、age 三个字段的值，存入 sort_buffer 中；</li><li>从索引 city 取下一个记录的主键 id；</li><li>重复步骤 3、4 直到不满足 city=‘杭州’条件为止，对应的主键 id 就是图中 ID_Y；</li><li>对 sort_buffer 中的数据按照字段 name 进行排序；</li><li>按照排序结果取前 1000 行返回给客户端。</li></ol><p>该执行流程如下图所示： <img src="/docs-lwg.github.io/assets/2.CnYobqOh.png" alt="image"></p><ul><li>图中“按 name 排序”这个动作，可能在内存中完成，也可能需要使用外部排序，这取决于排序所需的内存和参数 sort_buffer_size。</li><li>sort_buffer_size，就是 MySQL 为排序开辟的内存（sort_buffer）的大小。如果要排序的数据量小于 sort_buffer_size，排序就在内存中完成；但如果排序数据量太大，内存放不下，则不得不利用磁盘临时文件辅助排序。</li></ul><p><img src="/docs-lwg.github.io/assets/3.BkIZlXuc.png" alt="image"></p><p>以上是OPTIMIZER_TRACE结果，可通过number_of_tmp_files 中看到是否使用了临时文件。</p><ul><li>number_of_tmp_files 表示的是，排序过程中使用的临时文件数。</li><li>外部排序一般使用归并排序算法，MySQL将需要排序的数据划分成若干份，通过归并排序的思想将多个有序文件合并为一个有序的大文件。</li><li>如果 sort_buffer_size 超过了需要排序的数据量的大小，number_of_tmp_files 就是 0，表示排序可以直接在内存中完成</li><li>sort_buffer_size 越小，需要分成的份数越多，number_of_tmp_files 的值就越大。</li><li>图中，examined_rows=4000，表示参与排序的行数是 4000 行。</li><li>sort_mode 里面的packed_additional_fields的意思是，排序过程对字符串做了“紧凑”处理。即使 name 字段的定义是 varchar(16)，在排序过程中还是要按照实际长度来分配空间的。</li></ul><h2 id="rowid排序" tabindex="-1">rowid排序 <a class="header-anchor" href="#rowid排序" aria-label="Permalink to &quot;rowid排序&quot;">​</a></h2><p>全字段排序出现的问题：如果查询要返回的字段很多的话，那么 sort_buffer 里面要放的字段数太多，这样内存里能够同时放下的行数很少，要分成很多个临时文件，排序的性能会很差。<mark>因此，如果单行很大，排序效率不好。</mark></p><p>max_length_for_sort_data，是 MySQL 中专门控制用于排序的行数据的长度的一个参数。若单行的长度超过这个值，MySQL 就认为单行太大，要换一个算法。</p><p>新算法——rowid排序中，放入sort_buffer 的字段，只有要排序的列（即 name 字段）和主键 id。</p><p>整个执行流程如下所示：</p><ol><li>初始化 sort_buffer，确定放入两个字段，即 name 和 id；</li><li>从索引 city 找到第一个满足 city=‘杭州’条件的主键 id，也就是图中的 ID_X；</li><li>到主键 id 索引取出整行，取 name、id 这两个字段，存入 sort_buffer 中；</li><li>从索引 city 取下一个记录的主键 id；</li><li>重复步骤 3、4 直到不满足 city=‘杭州’条件为止，也就是图中的 ID_Y；</li><li>对 sort_buffer 中的数据按照字段 name 进行排序；</li><li>遍历排序结果，取前 1000 行，并按照 id 的值回到原表中取出 city、name 和 age 三个字段返回给客户端。</li></ol><p>示意图如下所示：</p><p><img src="/docs-lwg.github.io/assets/4.CGnoF4rS.png" alt="image"></p><ul><li><p>与全字段排序相比，rowid排序多访问了一次表 t 的主键索引，就是步骤 7。</p></li><li><p>实际上 MySQL 服务端从排序后的 sort_buffer 中依次取出 id，然后到原表查到 city、name 和 age 这三个字段的结果，不需要在服务端再耗费内存存储结果，是直接返回给客户端的。</p></li></ul><p>那么相应的OPTIMIZER_TRACE 部分输出结果如下所示：</p><p><img src="/docs-lwg.github.io/assets/5.DOtGvYom.png" alt="image"></p><ul><li>select @b-@a 这个语句的值变成 5000，因为在排序完成后，还要根据 id 去原表取值，由于语句是limit 1000，则多读1000行</li><li>sort_mode 变成了 ，表示参与排序的只有 name 和 id 这两个字段</li><li>number_of_tmp_files 变成 10 了，是因为这时候参与排序的行数虽然仍然是 4000 行，但是每一行都变小了，因此需要排序的总数据量就变小了，需要的临时文件也相应地变少了。</li></ul><h2 id="全字段排序-vs-rowid-排序" tabindex="-1">全字段排序 VS rowid 排序 <a class="header-anchor" href="#全字段排序-vs-rowid-排序" aria-label="Permalink to &quot;全字段排序 VS rowid 排序&quot;">​</a></h2><p>两种排序方法中，MySQL的选择原则：</p><ul><li>如果 MySQL 实在是担心排序内存太小，会影响排序效率，才会采用 rowid 排序算法，这样排序过程中一次可以排序更多行，但是需要再回到原表去取数据。</li><li>如果 MySQL 认为内存足够大，会优先选择全字段排序，把需要的字段都放到 sort_buffer 中，这样排序后就会直接从内存里面返回查询结果了，不用再回到原表去取数据。 体现了MySQL的设计思想：<strong>如果内存够，就要多利用内存，尽量减少磁盘访问</strong>。</li></ul><p>对于 InnoDB 表来说，rowid 排序会要求回表多造成磁盘读，因此不会被优先选择。</p><p>对于MySQL来说，排序是一种成本较高的操作，且<strong>并不是所有的order by语句都需要排序操作</strong>；MySQL生成临时表来做排序操作的原因是原本的数据是无序的。</p><h3 id="联合索引" tabindex="-1">联合索引 <a class="header-anchor" href="#联合索引" aria-label="Permalink to &quot;联合索引&quot;">​</a></h3><p>若保证从 city 这个索引上取出来的行，天然就是按照 name 递增排序的话，是不是就可以不用再排序了呢？</p><p><img src="/docs-lwg.github.io/assets/6.CRsNiZ-Z.png" alt="image"></p><p>以上是创建一个 city 和 name 的联合索引，对应的 SQL 语句是：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">alter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> table</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> t </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">add</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> city_user(city, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>在该索引中，可以用树搜索的方式定位到第一个满足 city=‘杭州’的记录，并且额外确保了，接下来按顺序取“下一条记录”的遍历过程中，只要 city 的值是杭州，name 的值就一定是有序的。</p><p>因此查询过程的流程改为：</p><ol><li>从索引 (city,name) 找到第一个满足 city=‘杭州’条件的主键 id；</li><li>到主键 id 索引取出整行，取 name、city、age 三个字段的值，作为结果集的一部分直接返回；</li><li>从索引 (city,name) 取下一个记录主键 id；</li><li>重复步骤 2、3，直到查到第 1000 条记录，或者是不满足 city=‘杭州’条件时循环结束。</li></ol><p>相应的示意图如下所示：</p><p><img src="/docs-lwg.github.io/assets/7.BM4tzO_Y.png" alt="image"></p><ul><li>该过程不需要临时表，也不需要排序。</li><li>由于(city,name) 这个联合索引本身有序，所以这个查询也不用把 4000 行全都读一遍，只要找到满足条件的前 1000 条记录就可以退出了。</li></ul><p>对于上述的改动，我们可以采用覆盖索引来进一步简化这个查询流程：</p><p>创建一个 city、name 和 age 的联合索引，对应的 SQL 语句就是：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">alter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> table</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> t </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">add</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> city_user_age(city, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, age);</span></span></code></pre></div><p>因此，查询过程的流程改为：</p><ol><li>从索引 (city,name,age) 找到第一个满足 city=‘杭州’条件的记录，取出其中的 city、name 和 age 这三个字段的值，作为结果集的一部分直接返回；</li><li>从索引 (city,name,age) 取下一个记录，同样取出这三个字段的值，作为结果集的一部分直接返回；</li><li>重复执行步骤 2，直到查到第 1000 条记录，或者是不满足 city=‘杭州’条件时循环结束。</li></ol><p>相应的示意图如下所示：</p><p><img src="/docs-lwg.github.io/assets/8.DPGHvz4x.png" alt="image"></p><p>需要注意的是：为了每个查询能用上覆盖索引，就要把语句中涉及的字段都建上联合索引，<strong>毕竟索引还是有维护代价的，这是一个需要权衡的决定</strong>。</p><h2 id="问题" tabindex="-1">问题 <a class="header-anchor" href="#问题" aria-label="Permalink to &quot;问题&quot;">​</a></h2><p>假设你的表里面已经有了 city_name(city, name) 这个联合索引，然后你要查杭州和苏州两个城市中所有的市民的姓名，并且按名字排序，显示前 100 条记录。如果 SQL 查询语句是这么写的 ：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mysql</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> select</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> t </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> city </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;杭州&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; 苏州 &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">order by</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>那么，这个语句执行的时候会有排序过程吗，为什么？</p><ul><li>虽然(city, name)联合索引中，对于单个city值，name是递增的</li><li>但是，SQL语句不是单独查找一个city的值，而是同时查找两个值，因此满足条件的name就不是递增的了。所以该语句需要进行排序</li></ul><p>来避免进行排序的解决方案：将该语句拆成两条语句，执行流程如下：</p><ol><li>执行 select * from t where city=&#39;杭州&#39; order by name limit 100；该语句就不需要排序，用数组A来保存结果；</li><li>执行 select * from t where city=&#39;苏州&#39; order by name limit 100；同样，用数组B保存结果；</li><li>可以用归并排序的思想将A和B两个数组合并为一个有序数组，并取得name最小的前100个值即可。</li></ol></div></div></main><footer class="VPDocFooter" data-v-95d215ae data-v-19c972ee><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-19c972ee><span class="visually-hidden" id="doc-footer-aria-label" data-v-19c972ee>Pager</span><div class="pager" data-v-19c972ee><a class="VPLink link pager-link prev" href="/docs-lwg.github.io/DATABASE/MySQL/chap14.html" data-v-19c972ee><!--[--><span class="desc" data-v-19c972ee>Previous page</span><span class="title" data-v-19c972ee>日志和索引相关问题</span><!--]--></a></div><div class="pager" data-v-19c972ee><a class="VPLink link pager-link next" href="/docs-lwg.github.io/DATABASE/MySQL/chap16.html" data-v-19c972ee><!--[--><span class="desc" data-v-19c972ee>Next page</span><span class="title" data-v-19c972ee>如何正确显示随机消息</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"database_mysql_chap11.md\":\"D9QHBC11\",\"intro.md\":\"qX2u62dJ\",\"database_mysql_chap09.md\":\"CrRBlfvf\",\"database_mysql_chap05.md\":\"D5YlfSyM\",\"database_mysql_chap12.md\":\"B11ENNeR\",\"database_mysql_chap08.md\":\"DH6AvHqC\",\"database_mysql_chap06.md\":\"fVfzN4Cm\",\"database_mysql_chap01.md\":\"BXGmwMK5\",\"database_mysql_chap14.md\":\"CWyIN-fN\",\"database_mysql_chap04.md\":\"D-tlVWIO\",\"database_mysql_chap13.md\":\"DA8nMhEp\",\"database_mysql_chap18.md\":\"xXJrKXQP\",\"database_mysql_chap16.md\":\"CHVTRi2S\",\"database_mysql_chap07.md\":\"FhCoKHAU\",\"database_mysql_chap00.md\":\"Duic4BKl\",\"database_mysql_chap10.md\":\"CNEWZt30\",\"database_mysql_chap03.md\":\"-IALFm8X\",\"java_基础_chapter1.md\":\"CfKlU_Yx\",\"java_基础_chapter13.md\":\"BMqjC2KY\",\"springboot_chapter1.md\":\"Cmf0m-SB\",\"database_mysql_chap17.md\":\"CZAipyip\",\"database_mysql_chap02.md\":\"DsYfQDol\",\"java_基础_chapter5.md\":\"DBsP8wSD\",\"java_集合框架_collection_arraydeque.md\":\"BYiGj3-V\",\"database_mysql_chap15.md\":\"BHHf80nm\",\"java_基础_chapter11.md\":\"CbGvtxB5\",\"java_基础_chapter6.md\":\"DRlTDDgK\",\"readme.md\":\"CGWpxOtT\",\"java_基础_chapter4.md\":\"D5lOyf8A\",\"java_基础_chapter9.md\":\"DNi6dRkN\",\"java_集合框架_collection_priorityqueue.md\":\"BBnylpda\",\"java_基础_chapter12.md\":\"4GyzkBo0\",\"index.md\":\"C0WjxjAK\",\"java_基础_chapter7.md\":\"DV37Urv6\",\"java_基础_chapter10.md\":\"DARL1F2o\",\"java_集合框架_collection-arraylist.md\":\"B6Tj4vLu\",\"java_基础_chapter2.md\":\"C-FX3FYX\",\"java_集合框架_collection_linkedlist.md\":\"DyemQ0BB\",\"java_基础_chapter14.md\":\"sTxzLVB3\",\"java_基础_chapter3.md\":\"C2qNndgh\",\"java_基础_chapter8.md\":\"DFl7xGdW\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"LWG Study\",\"description\":\"A VitePress Site\",\"base\":\"/docs-lwg.github.io/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://gitee.com/gasj0ee/java_No1_knowledge/tree/master/\"}],\"nav\":[{\"text\":\"DATABASE\",\"activeMatch\":\"/DATABASE/\",\"link\":\"/DATABASE/MySQL/chap00\"},{\"text\":\"SpringBoot\",\"activeMatch\":\"/SpringBoot/\",\"link\":\"/SpringBoot/chapter1\"},{\"text\":\"JAVA\",\"activeMatch\":\"/JAVA/\",\"link\":\"/JAVA/基础/chapter1\"}],\"sidebar\":{\"/SpringBoot/\":[{\"text\":\"chapter1\",\"link\":\"/SpringBoot/chapter1\"}],\"/DATABASE/\":[{\"text\":\"MySQL\",\"collapsed\":false,\"items\":[{\"text\":\"MySQL 底层数据结构：B+树\",\"link\":\"/DATABASE/MySQL/chap00\"},{\"text\":\"MySQL基础架构\",\"link\":\"/DATABASE/MySQL/chap01\"},{\"text\":\"MySQL日志系统\",\"link\":\"/DATABASE/MySQL/chap02\"},{\"text\":\"事务隔离\",\"link\":\"/DATABASE/MySQL/chap03\"},{\"text\":\"索引\",\"link\":\"/DATABASE/MySQL/chap04\"},{\"text\":\"全局锁和表锁\",\"link\":\"/DATABASE/MySQL/chap05\"},{\"text\":\"行锁\",\"link\":\"/DATABASE/MySQL/chap06\"},{\"text\":\"事务是否需要隔离\",\"link\":\"/DATABASE/MySQL/chap07\"},{\"text\":\"普通索引和唯一索引\",\"link\":\"/DATABASE/MySQL/chap08\"},{\"text\":\"MySQL为什么会选错索引？\",\"link\":\"/DATABASE/MySQL/chap09\"},{\"text\":\"如何给字符串加索引？\",\"link\":\"/DATABASE/MySQL/chap10\"},{\"text\":\"为什么 MySQL 会“抖”一下\",\"link\":\"/DATABASE/MySQL/chap11\"},{\"text\":\"MySQL数据库表的空间回收\",\"link\":\"/DATABASE/MySQL/chap12\"},{\"text\":\"count(\\\\*)语句\",\"link\":\"/DATABASE/MySQL/chap13\"},{\"text\":\"日志和索引相关问题\",\"link\":\"/DATABASE/MySQL/chap14\"},{\"text\":\"order by 是如何工作的\",\"link\":\"/DATABASE/MySQL/chap15\"},{\"text\":\"如何正确显示随机消息\",\"link\":\"/DATABASE/MySQL/chap16\"},{\"text\":\"为什么 SQL 语句逻辑相同，但性能却差异巨大？\",\"link\":\"/DATABASE/MySQL/chap17\"},{\"text\":\"为什么查询一行的语句，执行也会很慢\",\"link\":\"/DATABASE/MySQL/chap18\"}]}],\"/JAVA/\":[{\"text\":\"集合框架\",\"collapsed\":false,\"items\":[{\"text\":\"ArrayList源码解析\",\"link\":\"/JAVA/集合框架/Collection-ArrayList\"},{\"text\":\"Stack & Queue (采用 ArrayDeque 实现)\",\"link\":\"/JAVA/集合框架/Collection_ArrayDeque\"},{\"text\":\"Collection - LinkedList 源码解析\",\"link\":\"/JAVA/集合框架/Collection_LinkedList\"},{\"text\":\"PriorityQueue 源码解析\",\"link\":\"/JAVA/集合框架/Collection_PriorityQueue\"}]},{\"text\":\"基础\",\"collapsed\":false,\"items\":[{\"text\":\"Java 简介\",\"link\":\"/JAVA/基础/chapter1\"},{\"text\":\"类、源文件、包、jar、模块、工程\",\"link\":\"/JAVA/基础/chapter10\"},{\"text\":\"反射\",\"link\":\"/JAVA/基础/chapter11\"},{\"text\":\"异常和断言\",\"link\":\"/JAVA/基础/chapter12\"},{\"text\":\"日志\",\"link\":\"/JAVA/基础/chapter13\"},{\"text\":\"集合\",\"link\":\"/JAVA/基础/chapter14\"},{\"text\":\"Java 基本程序设计结构\",\"link\":\"/JAVA/基础/chapter2\"},{\"text\":\"类\",\"link\":\"/JAVA/基础/chapter3\"},{\"text\":\"接口\",\"link\":\"/JAVA/基础/chapter4\"},{\"text\":\"lambda表达式\",\"link\":\"/JAVA/基础/chapter5\"},{\"text\":\"内部类\",\"link\":\"/JAVA/基础/chapter6\"},{\"text\":\"代理\",\"link\":\"/JAVA/基础/chapter7\"},{\"text\":\"泛型\",\"link\":\"/JAVA/基础/chapter8\"},{\"text\":\"关键字\",\"link\":\"/JAVA/基础/chapter9\"}]}]}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>